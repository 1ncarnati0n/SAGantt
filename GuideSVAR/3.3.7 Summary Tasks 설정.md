Configuring summary tasks

출처: https://docs.svar.dev/react/gantt/guides/configuration/configure_summary

## `Default functionality`

`summary task`는 작업들, `milestones`과 다른 `summary tasks`들의 그룹입니다(또는 사용자가 만든 다른 `custom items`들). `summary task`는 다음의 기본 설정을 가집니다:

- `summary task`의 시작 및 종료 날짜는 `child tasks`에 따라 결정됩니다. `child task`가 `summary task`의 시작 날짜보다 이전으로 재스케줄되면, `summary task`의 시작 날짜가 변경됩니다. `child task`가 `summary task`의 종료 날짜보다 이후로 재스케줄되면, `summary task`의 종료 날짜가 변경됩니다.
- 그것의 시작 및 종료 날짜는 따로 변경될 수 없습니다. 그것이 `summary task`의 `bar`를 크기조정할 수 없는 이유입니다. 사용자는 `summary task`을 그것의 `child tasks`와 함께만 드래그할 수 있습니다. `summary task`이 이동되면, 모든 그것의 `child tasks`이 함께 이동됩니다.
- `summary tasks`의 진행도는 UI에서 수동으로 설정되며 그것의 `child tasks`의 진행도에 의존하지 않습니다.
- `child tasks`를 가진 작업들은 자동으로 `summary tasks`로 변환되지 않습니다, 사용자는 작업을 다른 타입으로 수동으로 변환할 수 있습니다.

`Gantt API`는 이 기본 동작을 구성하는 것을 허용합니다.

## `Enabling the auto calculation of summary tasks' progress`

기본적으로, 사용자는 작업들의 진행도를 수동으로만 설정할 수 있습니다. 아래의 예제는 그것의 `child tasks`의 진행도를 기반으로 `summary tasks`의 진행도의 자동 계산을 활성화하는 방법을 보여줍니다. 계산에 적용되는 공식은 ∑d*p / ∑d입니다, 여기서 "d"는 `task duration` 일 단위이고 "p"는 `task progress`이며, "∑"는 로드된 모든 작업들의 합계를 나타냅니다.

```javascript
import { useEffect, useRef } from "react";
import { getData } from "./data";
import { Gantt } from "wx-react-gantt";
import "wx-react-gantt/dist/gantt.css";

const dayDiff = (next, prev) => {
  const d = (next - prev) / 1000 / 60 / 60 / 24;
  return Math.ceil(Math.abs(d));
};

const data = getData();

const GanttComponent = () => {
  const tasks = data.tasks;
  const gApiRef = useRef();

  const getSummaryProgress = (id) => {
    const [totalProgress, totalDuration] = collectProgressFromKids(id);
    const res = totalProgress / totalDuration;
    return isNaN(res) ? 0 : Math.round(res);
  };

  const collectProgressFromKids = (id) => {
    let totalProgress = 0,
        totalDuration = 0;
    const kids = gApiRef.current.getTask(id).data;
    kids?.forEach((kid) => {
      let duration = 0;
      if (kid.type !== "milestone" && kid.type !== "summary") {
        duration = kid.duration || dayDiff(kid.end, kid.start);
        totalDuration += duration;
        totalProgress += duration * kid.progress;
      }
      const [p, d] = collectProgressFromKids(kid.id);
      totalProgress += p;
      totalDuration += d;
    });
    return [totalProgress, totalDuration];
  };

  const recalcSummaryProgress = (id, self) => {
    const { tasks } = gApiRef.current.getState();
    const task = gApiRef.current.getTask(id);
    if (task.type !== "milestone") {
      const summary = self && task.type === "summary" ? id : tasks.getSummaryId(id);
      if (summary) {
        const progress = getSummaryProgress(summary);
        gApiRef.current.exec("update-task", {
          id: summary,
          task: { progress },
        });
      }
    }
  };

  const init = (api) => {
    gApiRef.current = api;
    api.getState().tasks.forEach((task) => {
      recalcSummaryProgress(task.id, true);
    });
    api.on("add-task", ({ id }) => {
      recalcSummaryProgress(id);
    });
    api.on("update-task", ({ id }) => {
      recalcSummaryProgress(id);
    });
    api.on("delete-task", ({ source }) => {
      recalcSummaryProgress(source, true);
    });
    api.on("copy-task", ({ id }) => {
      recalcSummaryProgress(id);
    });
    api.on("move-task", ({ id, source, inProgress }) => {
      if (inProgress) return;
      if (api.getTask(id).parent !== source) recalcSummaryProgress(source, true);
      recalcSummaryProgress(id);
    });
  };

  return (
    <Gantt
      init={init}
      tasks={tasks}
      links={data.links}
      scales={data.scales}
      cellWidth={30}
    />
  );
};

export default GanttComponent;
```

## `Making parent tasks auto convert into summary tasks`

기본적으로, 사용자는 다른 작업들을 `summary task`로만 수동으로 변환할 수 있습니다. 아래의 예제는 모든 `parent tasks`를 자동으로 `summary task`로 변환하고 그 반대로도(하위 작업들이 없는 경우 "summary"에서 "task"로) 변환하는 방법을 보여줍니다.

`getTask` 메서드는 그것이 `parent task`인지를 식별하기 위해 사용됩니다. `api.exec()` 메서드는 `parent task`에 대해 `update-task` 액션을 트리거하고 `task type`을 "summary"로 변경합니다. 같은 메서드가 `data` 배열의 길이가 0인 경우(하위 항목들이 없음) `task type`을 "task"로 변경하기 위해 적용됩니다. `getState()` 메서드는 각 작업의 타입을 식별하고, `api.on()` 메서드는 `add-task`, `move-task`, `delete-task` 액션들을 리스닝하여 `parent tasks`를 `summary tasks`로 변환하고 데이터 로딩 중에 `summary tasks`를 명시적으로 업데이트합니다.

```javascript
import { useEffect, useRef } from "react";
import { getData } from "./data";
import { Gantt } from "wx-react-gantt";
import "wx-react-gantt/dist/gantt.css";

export default function SomeComponent({ skinSettings }) {
  const data = getData();
  const apiRef = useRef();

  const toSummary = (id, self) => {
    const task = apiRef.current.getTask(id);
    if (!self) id = task.parent;
    if (id && task.type !== "summary") {
      apiRef.current.exec("update-task", {
        id,
        task: { type: "summary" },
      });
    }
  };

  const toTask = (id) => {
    const obj = apiRef.current.getTask(id);
    if (obj && !obj.data?.length) {
      apiRef.current.exec("update-task", {
        id,
        task: { type: "task" },
      });
    }
  };

  useEffect(() => {
    if (apiRef.current) {
      // convert parent tasks to summary
      // will load data and then explicitly update summary tasks
      apiRef.current.getState().tasks.forEach((task) => {
        if (task.data?.length) {
          toSummary(task.id, true);
        }
      });
      apiRef.current.on("add-task", (ev) => {
        const { id, mode } = ev;
        if (mode === "child") toSummary(id);
      });
      apiRef.current.on("move-task", (ev) => {
        const { id, source, mode, inProgress } = ev;
        if (inProgress) return;
        if (mode === "child") toSummary(id);
        else toTask(source);
      });
      apiRef.current.on("delete-task", (ev) => {
        const { source } = ev;
        toTask(source);
      });
    }
  }, []);

  return (
    <Gantt
      apiRef={apiRef}
      tasks={data.tasks}
      links={data.links}
      scales={data.scales}
    />
  );
}
```

## `Disabling the ability to drag the bar of a summary task`

UI에서 `summary task`의 `bar`를 드래그하는 기능을 비활성화하려면, 아래의 예제에서 우리는 `api.intercept()` 메서드를 적용하여 "summary" `task type`에 대한 `drag-task` 액션을 수정합니다. `task type`을 식별하기 위해, 우리는 `getTask` 메서드를 적용합니다.

```javascript
import { useEffect, useRef } from "react";
import { getData } from "./data";
import { Gantt } from "wx-react-gantt";
import "wx-react-gantt/dist/gantt.css";

function GanttComponent() {
  const data = getData();
  const apiRef = useRef();

  useEffect(() => {
    if (apiRef.current) {
      apiRef.current.intercept("drag-task", ({ id, top }) => {
        return !(typeof top === "undefined" && apiRef.current.getTask(id).type === "summary");
      });
    }
  }, [apiRef.current]);

  return (
    <Gantt
      apiRef={apiRef}
      tasks={data.tasks}
      links={data.links}
      scales={data.scales}
    />
  );
}

export default GanttComponent;
```
